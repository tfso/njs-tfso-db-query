{"version":3,"file":"connection.js","sourceRoot":"","sources":["../../src/db/connection.ts"],"names":[],"mappings":"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","sourcesContent":["import * as MsSql from 'mssql';\r\n\r\nexport default class Connection {\r\n    private _connectionString: PromiseLike<MsSql.config>;\r\n    \r\n    private _connection: MsSql.Connection = null;\r\n    private _transaction: MsSql.Transaction = null;\r\n\r\n    private _rolledback = false;\r\n\r\n    constructor(connectionString: MsSql.config | PromiseLike<MsSql.config>) {\r\n        if (typeof connectionString == 'object') {\r\n            this._connectionString = Promise.resolve(connectionString);\r\n        } else {\r\n            this._connectionString = connectionString as PromiseLike<MsSql.config>;\r\n        }\r\n    }\r\n\r\n    public beginTransaction(): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            try {\r\n                if (this._transaction)\r\n                    reject(new Error('SqlConnection has a active transaction'));\r\n\r\n                this._connectionString\r\n                    .then((connectionString) => {\r\n                        this._connection = new MsSql.Connection(connectionString);\r\n                        this._transaction = new MsSql.Transaction(this._connection);\r\n\r\n                        this._rolledback = false;\r\n\r\n                        this._transaction.on('rollback', (aborted) => {\r\n                            this._rolledback = true;\r\n                        });\r\n\r\n                        this._connection.connect()\r\n                            .then(() => {\r\n                                return this._transaction.begin();\r\n                            })\r\n                            .then(() => {\r\n                                resolve();\r\n                            })\r\n                            .catch((err) => {\r\n                                reject(err);\r\n                            });\r\n                    });\r\n            }\r\n            catch (ex) {\r\n                reject(ex);\r\n            }\r\n        })\r\n    }\r\n\r\n    public commitTransaction(): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            try {\r\n                if (this._transaction == null)\r\n                    reject(new Error('SqlConnection has no active transaction'));\r\n\r\n\r\n                this._transaction.commit((err) => {\r\n                    this._transaction = null;\r\n\r\n                    if (this._connection && this._connection.connected)\r\n                        this._connection.close();\r\n\r\n                    return err ? reject(err) : resolve();\r\n                });\r\n            }\r\n            catch (ex) {\r\n                reject(ex);\r\n            }\r\n        });\r\n    }\r\n\r\n    public rollbackTransaction(): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            try {\r\n                if (this._transaction == null)\r\n                    reject(new Error('SqlConnection has no active transaction'));\r\n\r\n                if (!this._rolledback) {\r\n                    this._transaction.rollback(function (err) {\r\n                        this._transaction = null;\r\n\r\n                        if (this._connection && this._connection.connected)\r\n                            this._connection.close();\r\n\r\n                        return err ? reject(err) : resolve();\r\n                    });\r\n                }\r\n                else {\r\n                    this._transaction = null;\r\n\r\n                    if (this._connection && this._connection.connected)\r\n                        this._connection.close();\r\n\r\n                    resolve();\r\n                }\r\n            }\r\n            catch (ex) {\r\n                reject(ex);\r\n            }\r\n\r\n        })\r\n    }\r\n\r\n    public execute<U>(query: PromiseLike<U>): Promise<U>\r\n    public execute<U>(work: (connection: MsSql.Connection) => U | PromiseLike<U>): Promise<U>\r\n    public execute<U>(executable: any): Promise<U> {\r\n        return new Promise((resolve, reject) => {\r\n            try {\r\n                if (this._transaction != null) {\r\n                    if (this._connection.connected == false)\r\n                        throw new Error('SqlConnection is missing an active connection for this transaction');\r\n\r\n                    if (typeof executable == 'function') {\r\n                        Promise.resolve(executable(this._transaction || this._connection)).then(resolve).catch(reject);\r\n                    } else {\r\n                        executable.connection = this._transaction || this._connection;\r\n                        Promise.resolve(executable).then(resolve).catch(reject);\r\n                    }\r\n                }\r\n                else {\r\n                    this._connectionString\r\n                        .then((connectionString) => {\r\n                            var connection = new MsSql.Connection(connectionString);\r\n\r\n                            connection.connect()\r\n                                .then(() => {\r\n                                    if (typeof executable == 'function') {\r\n                                        return executable(connection);\r\n                                    } else {\r\n                                        executable.connection = connection;\r\n                                        return executable;\r\n                                    }\r\n                                })\r\n                                .then((result) => {\r\n                                    if (connection.connected)\r\n                                        connection.close();\r\n\r\n                                    resolve(result);\r\n                                })\r\n                                .catch(function (ex) {\r\n                                    if (connection.connected)\r\n                                        connection.close();\r\n\r\n                                    reject(ex);\r\n                                })\r\n                        });\r\n                }\r\n            }\r\n            catch (ex) {\r\n                reject(ex);\r\n            }\r\n        });\r\n    }\r\n\r\n}"]}