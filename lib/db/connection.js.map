{"version":3,"file":"connection.js","sourceRoot":"","sources":["../../src/db/connection.ts"],"names":[],"mappings":"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","sourcesContent":["import * as MsSql from 'mssql';\r\nimport { Query } from 'tfso-repository/lib/repository/db/query';\r\nimport { IRecordSet, RecordSet } from 'tfso-repository/lib/repository/db/recordset';\r\n\r\nexport enum IsolationLevel {\r\n    ReadUncommitted,\r\n    ReadCommitted,\r\n    RepeatableRead,\r\n    Snapshot,\r\n    Serializable\r\n}\r\n\r\nexport default class Connection {\r\n    private _connectionString: PromiseLike<MsSql.config>;\r\n    \r\n    private _connection: MsSql.ConnectionPool = null;\r\n    private _transaction: MsSql.Transaction = null;\r\n\r\n    private _rolledback = false;\r\n\r\n    constructor(connectionString: MsSql.config | PromiseLike<MsSql.config>) {\r\n        this._connectionString = Promise.resolve(connectionString);\r\n    }\r\n\r\n    public async close(): Promise<void> {\r\n        if (this._connection && this._connection.connected)\r\n            await this._connection.close();\r\n    }\r\n\r\n    public async beginTransaction(isolationLevel?: IsolationLevel): Promise<void> {\r\n        \r\n        if (this._transaction)\r\n            throw new Error('SqlConnection has a active transaction');\r\n\r\n        let connectionString = await this._connectionString\r\n            \r\n        this._connection = new MsSql.ConnectionPool(connectionString);\r\n        this._transaction = new MsSql.Transaction(this._connection);\r\n        this._rolledback = false;\r\n\r\n        this._transaction.on('rollback', (aborted) => {\r\n            this._rolledback = true;\r\n        });\r\n        \r\n        await this._connection.connect();\r\n        await this._transaction.begin(this.getIsolationLevel(isolationLevel));           \r\n    }\r\n\r\n    public async commitTransaction(): Promise<void> {\r\n        \r\n        if (this._transaction == null)\r\n            throw new Error('SqlConnection has no active transaction');\r\n\r\n        await this._transaction.commit();\r\n\r\n        this._transaction = null;\r\n\r\n        // if (this._connection && this._connection.connected)\r\n        //     await this._connection.close();\r\n    }\r\n\r\n    public async rollbackTransaction(): Promise<void> {       \r\n        if (this._transaction == null)\r\n            throw new Error('SqlConnection has no active transaction');\r\n\r\n        if (!this._rolledback)\r\n        {\r\n            let error: Error;\r\n\r\n            for (let tries = 0; tries < 5; tries++)\r\n            {\r\n                try\r\n                {\r\n                    error = null; // reset it for each try\r\n\r\n                    await this._transaction.rollback();\r\n\r\n                    break;\r\n                }\r\n                catch (ex)\r\n                {\r\n                    error = ex;\r\n\r\n                    if (ex.name == 'TransactionError')\r\n                    {\r\n                        await this.delay(200);\r\n\r\n                        continue;\r\n                    }\r\n\r\n                    throw ex;\r\n                }\r\n            }\r\n\r\n            this._transaction = null;\r\n\r\n            // if (this._connection && this._connection.connected)\r\n            //     await this._connection.close();\r\n\r\n            if(error)\r\n                throw error;\r\n        }\r\n        else {\r\n            this._transaction = null;\r\n\r\n            // if (this._connection && this._connection.connected)\r\n            //     await this._connection.close();\r\n        }   \r\n    }\r\n\r\n    public execute<U>(query: Query<U>): Promise<IRecordSet<U>>\r\n    public execute<U>(work: (connection: MsSql.ConnectionPool) => IRecordSet<U> | PromiseLike<IRecordSet<U>>): Promise<IRecordSet<U>>\r\n    public async execute<U>(executable: any): Promise<IRecordSet<U>> {\r\n        try {\r\n            if (this._transaction != null) {\r\n                if (this._connection.connected == false)\r\n                    throw new Error('SqlConnection is missing an active connection for this transaction');\r\n\r\n                if (typeof executable == 'function') {\r\n                    return Promise.resolve(executable(this._transaction || this._connection))\r\n                }\r\n                else {\r\n                    executable.connection = this._transaction || this._connection\r\n                    return Promise.resolve(executable)\r\n                }\r\n            }\r\n            else \r\n            {\r\n                let connectionString = await this._connectionString,\r\n                    connection = new MsSql.ConnectionPool(Object.assign(connectionString));\r\n\r\n                try {\r\n                    await connection.connect()\r\n\r\n                    let result;\r\n\r\n                    if (typeof executable == 'function') {\r\n                        result = await Promise.resolve(executable(connection))\r\n                    } else {\r\n                        executable.connection = connection;\r\n                        result = await Promise.resolve(executable)\r\n                    }\r\n                \r\n                    if (connection.connected)\r\n                        await connection.close();\r\n\r\n                    return result\r\n                }\r\n                catch(ex) {\r\n                    if (connection.connected)\r\n                        await connection.close();\r\n\r\n                    throw ex\r\n                }\r\n            }\r\n        }\r\n        catch (ex) {\r\n            throw ex\r\n        }\r\n       \r\n    }\r\n\r\n    private getIsolationLevel(isolationLevel: IsolationLevel): MsSql.IIsolationLevel {\r\n\r\n        switch (isolationLevel) {\r\n            case IsolationLevel.ReadCommitted:\r\n                return MsSql.ISOLATION_LEVEL.READ_COMMITTED;\r\n\r\n            case IsolationLevel.ReadUncommitted:\r\n                return MsSql.ISOLATION_LEVEL.READ_UNCOMMITTED;\r\n\r\n            case IsolationLevel.RepeatableRead:\r\n                return MsSql.ISOLATION_LEVEL.REPEATABLE_READ;\r\n\r\n            case IsolationLevel.Serializable:\r\n                return MsSql.ISOLATION_LEVEL.SERIALIZABLE;\r\n\r\n            case IsolationLevel.Snapshot:\r\n                return MsSql.ISOLATION_LEVEL.SNAPSHOT\r\n            \r\n            default:\r\n                return MsSql.ISOLATION_LEVEL.READ_COMMITTED;\r\n        }\r\n    }\r\n\r\n    private delay(ms: number) {\r\n        return new Promise((resolve) => {\r\n            setTimeout(resolve, ms || 1)\r\n        })\r\n    }\r\n}"]}